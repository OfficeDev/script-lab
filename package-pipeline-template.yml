parameters:
  - name: PackageDirectory
    displayName: Directory of the package where the package.json is
    type: string
  - name: PackageName
    displayName: Name of the package to be built
    type: string
  - name: SiteName
    displayName: Name of Azure Site
    type: string

steps:
  - checkout: self
    persistCredentials: true

  - task: PowerShell@2
    displayName: 'Install'
    inputs:
      filePath: 'scripts/azure.pipelines/pipeline.install.ps1'

  - task: Yarn@2
    displayName: 'Prettier'
    inputs:
      Arguments: 'prettier'

  - task: Yarn@2
    displayName: 'Lint'
    inputs:
      ProjectDirectory: '${{ parameters.PackageDirectory }}'
      Arguments: 'lint'

  - task: Yarn@2
    displayName: 'Test'
    inputs:
      ProjectDirectory: '${{ parameters.PackageDirectory }}'
      Arguments: 'citest'

  - task: Yarn@2
    displayName: 'Build'
    inputs:
      ProjectDirectory: '${{ parameters.PackageDirectory }}'
      Arguments: 'build'

  - script: yarn deploy
    displayName: 'Deploy Package'
    condition: and(succeeded(), eq(variables.isPR, false))
    env:
      HOME: '$(Agent.BuildDirectory)'
      BRANCH: '$(Build.SourceBranchName)'
      PULL_REQUEST: '$(isPR)'
      COMMIT_MESSAGE: '$(Build.SourceVersionMessage)'
      PACKAGE_LOCATION: '${{ parameters.PackageDirectory }}'
      PACKAGE_NAME: '${{ parameters.PackageName }}'
      SITE_NAME: '${{ parameters.SiteName}}'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_ALPHA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_ALPHA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_BETA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_BETA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STAGING: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STAGING)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STORYBOOK_ALPHA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STORYBOOK_ALPHA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STORYBOOK_BETA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STORYBOOK_BETA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STORYBOOK_STAGING: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_STORYBOOK_STAGING)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_RUNNER_ALPHA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_RUNNER_ALPHA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_RUNNER_BETA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_RUNNER_BETA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_RUNNER_STAGING: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_RUNNER_STAGING)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_SERVER_ALPHA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_SERVER_ALPHA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_SERVER_BETA: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_SERVER_BETA)'
      DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_SERVER_STAGING: '$(DEPLOYMENT_PASSWORD_SCRIPT_LAB_REACT_SERVER_STAGING)'
